<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Chat - Rooms</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script>
        let currentRoomId = null;

        function refreshMessages() {
            if (!currentRoomId) return;

            fetch(`/messages?room_id=${currentRoomId}`)
                .then(response => response.json())
                .then(messages => {
                    if (messages.error) {
                        // Handle unauthorized access
                        document.getElementById('message-list').innerHTML = `
                            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                                You are not authorized to view this room's messages.
                            </div>
                        `;
                        document.getElementById('message-form').style.display = 'none';
                        return;
                    }

                    const messageList = document.getElementById('message-list');
                    messageList.innerHTML = '';
                    // Reverse the messages array to show newest at the bottom
                    messages.reverse().forEach(msg => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'bg-white p-4 rounded-lg shadow mb-4';
                        messageDiv.innerHTML = `
                            <div class="flex items-center mb-2">
                                <span class="font-semibold text-blue-600">${msg.username}</span>
                                <span class="text-xs text-gray-500 ml-2">${new Date(msg.created_at).toLocaleString('en-GB', { hour12: false })}</span>
                            </div>
                            <p class="text-gray-800 whitespace-pre-wrap">${msg.content}</p>
                        `;
                        messageList.appendChild(messageDiv);
                    });
                    // Scroll to bottom of message list
                    messageList.scrollTop = messageList.scrollHeight;
                });
        }

        function selectRoom(roomId, isPrivate) {
            if (isPrivate && !isRoomAuthorized(roomId)) {
                showJoinRoomModal(roomId);
                return;
            }

            currentRoomId = roomId;
            document.getElementById('room_id').value = roomId;
            
            // Update active room styling
            document.querySelectorAll('.room-item').forEach(item => {
                if (item.dataset.roomId === roomId.toString()) {
                    item.classList.add('bg-blue-100');
                } else {
                    item.classList.remove('bg-blue-100');
                }
            });

            // Get selected room info and update header
            const selectedRoom = document.querySelector(`[data-room-id="${roomId}"]`);
            if (selectedRoom) {
                const roomName = selectedRoom.querySelector('h3').textContent;
                const isPrivateRoom = selectedRoom.querySelector('.bg-yellow-100') !== null;
                
                // Update room header
                document.getElementById('current-room-name').textContent = roomName;
                document.getElementById('room-status').textContent = isPrivateRoom ? 'Private Room' : 'Public Room';
            }

            // Show chat area with flex display
            document.getElementById('chat-area').style.display = 'flex';
            
            // Clear and refresh messages
            document.getElementById('message-list').innerHTML = '';
            refreshMessages();

            // Focus on message input
            document.getElementById('message').focus();
        }

        function showJoinRoomModal(roomId) {
            const modal = document.getElementById('join-room-modal');
            document.getElementById('join-room-id').value = roomId;
            modal.classList.remove('hidden');
        }

        function hideJoinRoomModal() {
            const modal = document.getElementById('join-room-modal');
            modal.classList.add('hidden');
            document.getElementById('join-room-password').value = '';
        }

        function joinRoom(event) {
            event.preventDefault();
            const roomId = document.getElementById('join-room-id').value;
            const password = document.getElementById('join-room-password').value;

            fetch('/join-room', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `room_id=${roomId}&room_password=${password}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    hideJoinRoomModal();
                    // Update the room header immediately
                    document.getElementById('current-room-name').textContent = data.room_name;
                    document.getElementById('room-status').textContent = data.is_private ? 'Private Room' : 'Public Room';
                    
                    // Show the chat area
                    document.getElementById('chat-area').style.display = 'flex';
                    document.getElementById('message-form').style.display = 'block';
                    
                    // Set the current room ID and update the form
                    currentRoomId = data.room_id;
                    document.getElementById('room_id').value = data.room_id;
                    
                    // Update active room styling
                    document.querySelectorAll('.room-item').forEach(item => {
                        if (item.dataset.roomId === data.room_id.toString()) {
                            item.classList.add('bg-blue-100');
                        } else {
                            item.classList.remove('bg-blue-100');
                        }
                    });
                    
                    // Refresh messages
                    refreshMessages();
                    
                    // Focus on message input
                    document.getElementById('message').focus();
                } else {
                    alert(data.message || 'Failed to join room');
                }
            });
        }

        function isRoomAuthorized(roomId) {
            const authorizedRooms = {{ authorized_rooms|tojson }};
            return !roomId || authorizedRooms.includes(roomId);
        }

        // Refresh messages every 1 second
        setInterval(refreshMessages, 1000);

        // Save username to localStorage
        function saveUsername() {
            const username = document.getElementById('username').value;
            if (username) {
                localStorage.setItem('chatUsername', username);
            }
        }

        // Load saved username
        document.addEventListener('DOMContentLoaded', () => {
            const savedUsername = localStorage.getItem('chatUsername');
            if (savedUsername) {
                document.getElementById('username').value = savedUsername;
            }
            // Hide message form initially
            document.getElementById('message-form').style.display = 'none';
        });

        // Add this function to handle message sending
        function sendMessage() {
            const message = document.getElementById('message').value;
            const roomId = document.getElementById('room_id').value;
            const username = '{{ session["username"] }}';

            if (!message.trim()) return;

            fetch('/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `message=${encodeURIComponent(message)}&room_id=${roomId}&username=${encodeURIComponent(username)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Clear the message input
                    document.getElementById('message').value = '';
                    // Refresh messages to show the new one
                    refreshMessages();
                } else {
                    alert(data.message || 'Error sending message');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error sending message');
            });
        }

        // Add event listener for Enter key in message input
        document.getElementById('message').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Join Room Modal -->
    <div id="join-room-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Join Private Room</h3>
                <form onsubmit="joinRoom(event)" class="space-y-4">
                    <input type="hidden" id="join-room-id">
                    <div>
                        <label for="join-room-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="join-room-password" 
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="hideJoinRoomModal()"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                            Cancel
                        </button>
                        <button type="submit"
                            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md">
                            Join Room
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <div class="max-w-5xl mx-auto">
            <div class="flex justify-between items-start mb-8">
                <h1 class="text-3xl font-bold text-gray-800">Local Chat Rooms</h1>
                
                <div class="flex items-center space-x-4">
                    <span class="text-gray-600">Welcome, {{ session['username'] }}</span>
                    <a href="{{ url_for('logout') }}" 
                        class="bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 transition duration-200">
                        Logout
                    </a>
                </div>
            </div>

            <!-- Create Room Form - Moved to top -->
            <div class="bg-white rounded-lg shadow-lg p-6" style="min-width: 300px;">
                <h2 class="text-xl font-semibold mb-4">Create Room</h2>
                <form action="{{ url_for('create_room') }}" method="POST" class="space-y-3">
                    <div>
                        <input type="text" name="room_name" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="New room name" required>
                    </div>
                    <div>
                        <input type="password" name="room_password" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Room password (optional)">
                        <p class="text-xs text-gray-500 mt-1">Leave empty for public room</p>
                    </div>
                    <button type="submit" 
                        class="w-full bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 transition duration-200">
                        Create Room
                    </button>
                </form>
            </div>

            {% with messages = get_flashed_messages() %}
                {% if messages %}
                    {% for message in messages %}
                        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <!-- Room List Overview -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Available Rooms</h2>
                    <span class="text-sm text-gray-500">{{ rooms|length }} rooms total</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% for room in rooms %}
                    <div class="room-item border rounded-lg p-4 hover:bg-gray-50 transition-colors duration-200 cursor-pointer"
                         onclick="selectRoom({{ room.id }}, {{ room.is_private|tojson }})"
                         data-room-id="{{ room.id }}">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-medium text-lg text-gray-900">{{ room.name }}</h3>
                            {% if room.is_private %}
                            <span class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full">Private</span>
                            {% else %}
                            <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Public</span>
                            {% endif %}
                        </div>
                        <div class="text-sm text-gray-500">
                            Created {{ room.created_at|datetime }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Chat Area -->
            <div id="chat-area" class="bg-white rounded-lg shadow-lg flex flex-col min-h-[600px]" style="display: none;">
                <!-- Current Room Header -->
                <div id="current-room-header" class="border-b bg-gray-50">
                    <div class="p-4">
                        <h2 id="current-room-name" class="text-xl font-semibold text-gray-800"></h2>
                        <p id="room-status" class="text-sm text-gray-500 mt-1"></p>
                    </div>
                </div>

                <!-- Messages List -->
                <div id="message-list" class="flex-grow overflow-y-auto p-6 space-y-4">
                    <!-- Messages will be loaded here -->
                </div>

                <!-- Message Form -->
                <div id="message-form" class="border-t bg-white p-6 mt-auto">
                    <form id="message-form-element" onsubmit="return false;" class="space-y-4">
                        <input type="hidden" id="room_id" name="room_id">
                        <input type="hidden" name="username" value="{{ session['username'] }}">
                        <div>
                            <label for="message" class="block text-sm font-medium text-gray-700 mb-2">New Message</label>
                            <textarea id="message" name="message" rows="3" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Type your message here..." required></textarea>
                        </div>
                        <button type="button" onclick="sendMessage()"
                            class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
                            Send Message
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 